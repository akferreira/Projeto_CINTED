<!doctype html>
<html>
<head>
  <title>Network</title>
  <script type="text/javascript" src="vis-network.min.js"></script>
  <script  type="text/css" src="vis-network.min.css"  rel="stylesheet" ></script>
  <style type="text/css">
    #mynetwork {
      width: 2000px;
      height: 1080px;
      border: 1px solid lightgray;
    }
  </style>
</head>
<body>
<div id="mynetwork"></div>
<pre id="eventSpan"></pre>
<!--<img id="canvasImg" alt="Right click to save me!">-->

<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="neo4j-web.min.js"></script>
<!--<script src="https://unpkg.com/neo4j-driver@1.7.6/lib/browser/neo4j-web.min.js"></script>-->
<script type="text/javascript" src="canvas2svg.js"></script>

<script type="text/javascript" src="cinted.js"></script>
<script type="text/javascript">








var mapCoursePosition =  new Map;

var toggle = 1;






const driver = neo4j.v1.driver("bolt://localhost:7687", neo4j.v1.auth.basic("neo4j", "cinted"));
const session = driver.session();
userid = 24

const resultPromise = session.run(
  `match (A)-[r:MATRICULADO {userid: '${userid}'}]->(B) return A,LABELs(A) as typeA,r,B,LABELs(B) as typeB,id(A),id(B),B.courseid`
);

var node_info = new vis.DataSet();
var r_info = new vis.DataSet();
var network;

var mapAccess = new Map;

 C2S.prototype.circle = CanvasRenderingContext2D.prototype.circle;
    C2S.prototype.square = CanvasRenderingContext2D.prototype.square;
    C2S.prototype.triangle = CanvasRenderingContext2D.prototype.triangle;
    C2S.prototype.triangleDown = CanvasRenderingContext2D.prototype.triangleDown;
    C2S.prototype.star = CanvasRenderingContext2D.prototype.star;
    C2S.prototype.diamond = CanvasRenderingContext2D.prototype.diamond;
    C2S.prototype.roundRect = CanvasRenderingContext2D.prototype.roundRect;
    C2S.prototype.ellipse_vis = CanvasRenderingContext2D.prototype.ellipse_vis;
    C2S.prototype.database = CanvasRenderingContext2D.prototype.database;
    C2S.prototype.arrowEndpoint = CanvasRenderingContext2D.prototype.arrowEndpoint;
    C2S.prototype.circleEndpoint = CanvasRenderingContext2D.prototype.circleEndpoint;
    C2S.prototype.dashedLine = CanvasRenderingContext2D.prototype.dashedLine;
    var network_position;
    var network_scale;
    
    
    function exportSvg()
    {
        var networkContainer = network.body.container;
        network_position = network.getViewPosition();
        network_scale = network.getScale();
        console.log(`\nscale ${network_scale}`);
        
        network.fit();
        var ctx = new C2S({width: networkContainer.clientWidth, height: networkContainer.clientHeight, embedImages: true});
        var canvasProto = network.canvas.__proto__;
        var currentGetContext = canvasProto.getContext;
        canvasProto.getContext = function()
        {
            return ctx;
        }
       

         network.redraw();
        canvasProto.getContext = currentGetContext;
        ctx.waitForComplete(function()
            {
                var svg = ctx.getSerializedSvg();
                showSvg(svg);
            });
    }
    function showSvg(svg)
    {
        var svgBlob = new Blob([svg], {type: 'image/svg+xml'});
        openBlob(svgBlob, "network.svg");
        network.moveTo({scale : network_scale,position: network_position});
         network.redraw();
         network_scale = network.getScale();
        console.log(`\nscale ${network_scale}`);
        network.redraw();
    }
    
    function openBlob(blob, fileName)
	  {
		if(window.navigator && window.navigator.msSaveOrOpenBlob)
        {
            //blobToDataURL(blob, function(dataurl){window.open(dataurl);});
            window.navigator.msSaveOrOpenBlob(blob,fileName);
        }
        else
        {
			var a = document.getElementById("blobLink");
			if(!a)
			{
				a = document.createElement("a");
				document.body.appendChild(a);
				a.setAttribute("id", "blobLink");
				a.style = "display: none";
			}
			var data = window.URL.createObjectURL(blob);
			a.href = data;
			a.download = fileName;
			a.click();
			setTimeout(function()
				{
				// For Firefox it is necessary to delay revoking the ObjectURL
				window.URL.revokeObjectURL(data);
				}
				, 100);
        }
    }

resultPromise.then(result => {
    session.close();
    create_graph_course_order(result);


    console.log(node_info);


    // create a network
    //nodes: nodes,
    //  edges: edges,
    //
    var container = document.getElementById('mynetwork');
    var data = {
        nodes: node_info,
        edges: r_info,
        options: options
    };
    var options = {
    nodes: {
                shapeProperties: {
                    interpolation: false //so images are not scaled svg will get full image
                },
                scaling: { label: { drawThreshold : 0} },
                font:{color:'#000000'}
            },

    groups: {
    
    Courses: {

        shape: 'circle',
        color: '#FFA07A',

        widthConstraint: { maximum: 120 }
        
    },

    Student: {

        shape: 'circle',
        color: '#228B22',

        widthConstraint: { maximum: 120 }
        
    },
    Resources: {

        shape: 'circle',

        widthConstraint: { maximum: 120 }
        
    }
    },


physics: {
        "barnesHut": {
      "avoidOverlap": 1
    },
    
        repulsion: {
            springLength: 50,
            nodeDistance: 300,
            centralGravity: 0,
            springConstant: 0.15,
        },
        stabilization: true
    },


        edges:{
        
        font: {
            size: 28
        },
        arrows: 'to',
        color: 'red',
        scaling:{
            label: true,
        },
        shadow: true,
         smooth: true,
    }



    };
    network = new vis.Network(container, data, options);
  
    network.on( 'click', function(properties) {
    var ids = properties.nodes;
    var clickedNodes = node_info.get(ids);
    console.log('clicked nodes:', clickedNodes);
    
    for (node of clickedNodes){
        if(node['courseid'] != null){
            console.log(`Course id is ${node['courseid']} ....`)
        }
    
        
    }
        var ids = properties.nodes;
        var clickedNodes = node_info.get(ids);
        courseid = clickedNodes[0]['courseid']
        
        if(courseid == null){
            return;
        }
        
        console.log('clicked nodes:', clickedNodes);
        const resultPromise = session.run(
        `match (C:Student {userid : '${userid}'})-[r:ACCESS_ORDER {userid : '${userid}'}]->(B:Resources  {courseid : '${courseid}'}),(A:Courses {courseid : '${courseid}'}) return A,LABELs(A) as typeA,r,B,LABELs(B) as typeB,id(A),id(B) order by r.id union match (A:Resources  {courseid : '${courseid}'})-[r:ACCESS_ORDER {userid : '${userid}'}]->(B:Resources  {courseid : '${courseid}'}) return A,LABELs(A) as typeA,r,B,LABELs(B) as typeB,id(A),id(B) order by id(r)`
        );

        resultPromise.then(result => {
            session.close();
            console.log(result)
            
            var already_added = mapAccess.has(courseid);
            var hide;
            
            if(already_added == true) {
                hide = !mapAccess.get(courseid);
                mapAccess.set(courseid, hide);
            }
            else {
                hide = false;
                mapAccess.set(courseid, false);
            }
            console.log(`${already_added}//${hide}//course ${courseid}`);
            
            create_graph_access_order(result, hide,courseid);
            network.body.emitter.emit('_dataChanged')
            network.redraw();
            console.log("finished")
            teste();
        
        
       });
        
        
    });
    
    
    // on application exit:
    driver.close();
});



</script>


<input type="button" onclick="exportSvg();" value="Exportar para SVG"/>
</body>
</html>
